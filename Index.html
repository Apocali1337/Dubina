<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dubina: Deluxe Edition</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Pou≈æit√≠ fontu Share Tech Mono pro termin√°lov√Ω vzhled -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <!-- Font Awesome pro ikony -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Z√°kladn√≠ styly pro tƒõlo str√°nky */
        body {
            font-family: 'Share Tech Mono', monospace; /* Termin√°lov√Ω font */
            background-color: #000000; /* ƒåistƒõ ƒçern√© pozad√≠ */
            color: #d1ffb8; /* Svƒõtle zelen√Ω text */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
            position: relative; /* Pro overlay matrix */
            overflow: hidden; /* Aby matrix nep≈ôet√©kal */
        }

        /* Matrix pozad√≠ pomoc√≠ pseudo-elementu */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1; /* Puts it behind the game content */
            background-color: #000000; /* Base dark background */
            background-image:
                repeating-linear-gradient(0deg, rgba(0, 255, 0, 0.03) 0px, rgba(0, 255, 0, 0.03) 1px, transparent 1px, transparent 3px),
                repeating-linear-gradient(90deg, rgba(0, 255, 0, 0.03) 0px, rgba(0, 255, 0, 0.03) 1px, transparent 1px, transparent 3px);
            background-size: 4px 4px; /* Velikost "pixel≈Ø" */
            animation: matrix-subtle-glow 15s linear infinite alternate; /* Jemn√© pulzov√°n√≠/pohyb */
            opacity: 1; 
        }

        @keyframes matrix-subtle-glow {
            0% { background-position: 0 0; }
            100% { background-position: 100% 100%; }
        }

        /* Kontejner hry */
        #game-container {
            background-color: #000000; /* Stejn√© pozad√≠ jako body */
            border-radius: 0; /* Ostr√© rohy */
            padding: 0; /* Minimalistick√Ω padding na kontejneru */
            width: 100%;
            max-width: 650px; /* Zvƒõt≈°en√° ≈°√≠≈ôka */
            box-shadow: none;
            display: flex;
            flex-direction: column;
            gap: 0; /* Bez mezery mezi hlavn√≠mi segmenty */
            border: 1px solid #1a2a1a; /* Jemn√Ω okraj pro vizu√°ln√≠ oddƒõlen√≠ */
        }
        /* Styly pro nadpisy sekc√≠ (pokud by se nƒõkdy vr√°tily) */
        .section-title {
            color: #79d70f; /* Jasnƒõ zelen√° */
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1.25rem;
            text-transform: uppercase;
        }
        /* Styly pro prim√°rn√≠ tlaƒç√≠tka */
        .btn-primary {
            background-color: #1a2a1a; /* Velmi tmav√° zelen√° pro v√Ωchoz√≠ stav */
            color: #d1ffb8; /* Svƒõtle zelen√Ω text */
            padding: 0.75rem 1.5rem;
            border-radius: 0.25rem; /* Zaoblen√© rohy */
            font-weight: 700;
            transition: background-color 0.1s, color 0.1s;
            box-shadow: none;
            text-transform: uppercase;
            border: 1px solid #79d70f; /* Zelen√Ω okraj */
        }
        /* Hover efekt pro prim√°rn√≠ tlaƒç√≠tka */
        .btn-primary:hover:not(:disabled) {
            background-color: #79d70f; /* Jasnƒõ zelen√° p≈ôi najet√≠ */
            color: #0d120a; /* Tmav√Ω text */
            transform: none; /* Bez transformace */
        }
        /* Styly pro deaktivovan√° prim√°rn√≠ tlaƒç√≠tka */
        .btn-primary:disabled {
            opacity: 0.5; /* Vy≈°≈°√≠ pr≈Øhlednost pro disabled */
            cursor: not-allowed;
            background-color: #0f1a0f; /* Tmav≈°√≠ zelen√° pro disabled */
            border-color: #378b29; /* Odpov√≠daj√≠c√≠ okraj */
            color: #708070; /* Ztlumen√° zelen√° barva textu */
        }
        /* Styly pro sekund√°rn√≠ tlaƒç√≠tka (pro z√°lo≈æky) */
        .btn-secondary {
            background-color: transparent;
            color: #d1ffb8;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem; /* Zaoblen√© rohy */
            font-weight: 700;
            transition: color 0.1s, border-color 0.1s;
            border-bottom: 2px solid transparent; /* Pro zelenou ƒç√°ru pod aktivn√≠ z√°lo≈ækou */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        /* Hover efekt pro sekund√°rn√≠ tlaƒç√≠tka */
        .btn-secondary:hover:not(:disabled) {
            color: #79d70f; /* Jasnƒõ zelen√° */
        }
        /* Styly pro deaktivovan√° sekund√°rn√≠ tlaƒç√≠tka */
        .btn-secondary:disabled {
            opacity: 0.5; /* Nastaveno na 0.5 pro viditelnost */
            cursor: not-allowed;
            color: #708070; /* Ztlumen√° zelen√° barva textu */
        }
        /* Styly pro karty polo≈æek */
        .item-card {
            background-color: #0a0a0a; /* Stejn√© pozad√≠ */
            padding: 0.75rem 1rem; /* Men≈°√≠ padding */
            border-radius: 0.25rem; /* Zaoblen√© rohy */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Men≈°√≠ mezera */
            box-shadow: none;
            border-bottom: 1px solid #1a2a1a; /* Jemn√Ω oddƒõlovaƒç */
        }
        .item-card:last-child {
            border-bottom: none; /* Bez okraje u posledn√≠ho prvku */
        }
        .item-card-details {
            flex-grow: 1;
        }
        .item-card-title {
            font-weight: 700;
            font-size: 1rem; /* Men≈°√≠ n√°zev */
            color: #d1ffb8;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.25rem; /* Men≈°√≠ mezera */
        }
        .item-card-title .price {
            color: #79d70f; /* Jasnƒõ zelen√° */
            font-size: 0.9rem;
        }
        .item-card-stats {
            font-size: 0.8rem; /* Men≈°√≠ text statistik */
            color: #a0f0a0; /* Svƒõtlej≈°√≠ zelen√° */
        }
        /* Styly pro polo≈æky achievement≈Ø */
        .achievement-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            background-color: #0a0a0a;
            padding: 0.75rem 1rem;
            border-radius: 0.25rem; /* Zaoblen√© rohy */
            border-bottom: 1px solid #1a2a1a;
        }
        .achievement-item:last-child {
            border-bottom: none;
        }
        .achievement-item-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.8rem;
            color: #a0f0a0;
            width: 100%;
            justify-content: space-between;
        }
        /* Styly pro splnƒõn√© achievementy */
        .achievement-item.completed {
            color: #79d70f;
        }
        .achievement-item.completed .check-icon {
            color: #79d70f;
        }
        /* Ikona za≈°krtnut√≠/pr√°zdn√©ho ƒçtverce pro achievementy */
        .check-icon {
            margin-right: 0.25rem;
            color: #a0f0a0;
        }
        /* Styly pro aktivn√≠ z√°lo≈ækov√© tlaƒç√≠tko */
        .tab-button.active-tab {
            border-color: #79d70f; /* Jasnƒõ zelen√Ω spodn√≠ okraj */
            color: #79d70f; /* Jasnƒõ zelen√Ω text */
        }
        /* Skryt√≠ z√°lo≈ækov√©ho panelu */
        .tab-panel.hidden {
            display: none;
        }
        /* Styl pro zpr√°vu o v√Ωdƒõlku z kliknut√≠ */
        #click-feedback {
            color: #79d70f;
            transition: opacity 0.5s ease-out;
            font-weight: 700;
        }

        /* Styl pro log panel */
        #operation-log-container {
            background-color: #0a0a0a;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column;
            margin-top: 0;
            border-top: 1px solid #1a2a1a; /* Jemn√Ω oddƒõlovaƒç */
            padding-top: 0;
        }

        #operation-log {
            height: 12rem; /* Pevn√° v√Ω≈°ka pro 10 ≈ô√°dk≈Ø */
            overflow: hidden;
            background-color: transparent;
            border-radius: 0;
            padding: 0.5rem 1rem; /* Padding pro log */
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8rem;
            border: none;
            display: grid;
            grid-template-columns: 100px 1fr auto; /* Upraven√© ≈°√≠≈ôky sloupc≈Ø */
            column-gap: 0.5rem;
            grid-template-rows: repeat(10, 1.2rem);
            align-content: start;
        }

        .log-entry {
            display: contents;
        }

        .log-entry .log-prefix {
            font-weight: 700;
            color: #79d70f; /* Jasnƒõ zelen√° */
            white-space: nowrap;
        }

        .log-entry .log-message {
            color: #d1ffb8; /* Svƒõtle zelen√Ω text zpr√°vy */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .log-entry .log-amount {
            color: #79d70f; /* Jasnƒõ zelen√° pro z√≠skan√© pen√≠ze */
            text-align: right;
            white-space: nowrap;
        }

        /* Styling pro ƒçerven√Ω text p≈ôi ztr√°tƒõ */
        .log-entry.loss .log-message,
        .log-entry.loss .log-amount,
        .log-entry.loss .log-prefix {
            color: #ff6b6b; /* ƒåervenƒõj≈°√≠ */
        }
        /* Styling pro v√Ωzkum aktivovan√Ω (≈ælut√°) */
        .log-entry.research-activated .log-message,
        .log-entry.research-activated .log-amount,
        .log-entry.research-activated .log-prefix {
            color: #ffea00; /* ≈Ωlutƒõj≈°√≠ */
        }


        /* Styly pro ikony hlavy bot≈Ø */
        .bot-head-icon {
            display: inline-block;
            width: 14px; /* Men≈°√≠ ikony */
            height: 14px;
            vertical-align: middle;
            margin-left: 2px;
        }
        .bot-head-icon.white { fill: #d1ffb8; }
        .bot-head-icon.green { fill: #79d70f; }
        .bot-head-icon.blue { fill: #60a5fa; } /* Modr√° z≈Øst√°v√° */
        .bot-head-icon.purple { fill: #c084fc; } /* Fialov√° z≈Øst√°v√° */

        /* Styly pro mod√°ln√≠ okno mini-hry */
        #mini-game-modal {
            animation: fadeIn 0.3s ease-out;
            background-color: rgba(0, 0, 0, 0.95); /* Tmav≈°√≠ p≈ôekryt√≠ */
        }
        #mini-game-modal .bg-zinc-800 {
            background-color: #1a2a1a; /* Tmav≈°√≠ zelen√° */
            border: 1px solid #79d70f; /* Zelen√Ω okraj */
            color: #d1ffb8;
            border-radius: 0.25rem; /* Zaoblen√© rohy */
        }
        #mini-game-modal h3 {
            color: #79d70f;
        }
        #mini-game-modal p {
            color: #a0f0a0;
        }
        #mini-game-modal #code-display {
            background-color: #0d120a; /* Velmi tmav√© pozad√≠ pro k√≥d */
            color: #d1ffb8; /* Zelen√Ω k√≥d */
            border: 1px solid #79d70f;
            text-shadow: 0 0 5px #79d70f; /* Lehk√Ω neonov√Ω efekt */
            border-radius: 0.25rem; /* Zaoblen√© rohy */
        }
        #mini-game-modal #code-input {
            background-color: #0d120a;
            border: 1px solid #79d70f;
            color: #d1ffb8;
            border-radius: 0.25rem; /* Zaoblen√© rohy */
        }
        #mini-game-modal #code-input:focus {
            ring-color: #79d70f;
            box-shadow: 0 0 5px #79d70f;
        }
        #mini-game-modal #timer-display {
            color: #79d70f;
        }
        #mini-game-modal #mini-game-feedback {
            font-weight: 700;
        }

        /* Nov√© styly pro kompaktn√≠ sekci n√°boru a v√Ωzkumu */
        .compact-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem; /* Men≈°√≠ mezera */
            padding: 0.5rem 0.75rem; /* Men≈°√≠ padding */
            border-radius: 0.25rem; /* Zaoblen√© rohy */
            background-color: #0d120a; /* Tmav≈°√≠ pozad√≠ pro vno≈ôen√© sekce */
            border: 1px solid #1a2a1a; /* Jemn√Ω okraj */
            border-left: none; /* Odstranit nƒõkter√© okraje pro ƒçist≈°√≠ vzhled */
            border-right: none;
        }
        .compact-section:first-of-type {
            border-top: none; /* Bez horn√≠ho okraje u prvn√≠ho */
        }
        .compact-section-details {
            flex-grow: 1;
        }
        .compact-section .btn-primary {
            width: auto;
            padding: 0.3rem 0.6rem; /* Velmi mal√© tlaƒç√≠tka */
            font-size: 0.75rem;
        }
        .compact-section .text-xs {
            font-size: 0.7rem; /* Je≈°tƒõ men≈°√≠ text */
        }
        .compact-section .text-sm {
            font-size: 0.8rem; /* Men≈°√≠ text uvnit≈ô sekc√≠ */
        }

        /* Welcome Modal specific styles */
        #welcome-modal {
            position: fixed;
            inset: 0;
            background-color: #000000; /* Pure black background */
            z-index: 1000; /* High z-index to cover everything */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            color: #d1ffb8;
            font-size: 1.1rem;
            line-height: 1.5;
        }
        /* This rule is crucial to ensure the modal hides correctly */
        #welcome-modal.hidden {
            display: none !important; 
        }

        #welcome-modal h2 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #79d70f;
            margin-bottom: 1.5rem;
            text-shadow: 0 0 10px #79d70f; /* Neon glow */
        }

        #welcome-modal p {
            max-width: 500px;
            margin-bottom: 1rem; /* Smaller margin for multiple paragraphs */
        }

        #welcome-modal button {
            background-color: #1a2a1a;
            color: #d1ffb8;
            padding: 0.75rem 2rem;
            border-radius: 0.25rem;
            font-weight: 700;
            border: 1px solid #79d70f;
            transition: background-color 0.1s, color 0.1s;
            margin-top: 2rem; /* Margin for button after paragraphs */
        }

        #welcome-modal button:hover {
            background-color: #79d70f;
            color: #0d120a;
        }

        /* Initially hide game container until welcome modal is dismissed */
        #game-container.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-300 flex justify-center items-center min-h-screen p-4">

    <div id="grain-overlay"></div>

    <!-- Welcome Modal -->
    <div id="welcome-modal">
        <h2>V√≠tej ve svƒõtƒõ Dubina: Deluxe Edition! üåÜ</h2>
        <p>Tady nejde o fair play ‚Äì jde o moc, pen√≠ze a respekt. Zaƒç√≠n√°≈° jako obyƒçejn√° Dubinsk√° ≈°eple≈•. Tv√Ωm c√≠lem? Vybudovat drogov√© imp√©rium, kter√© ovl√°dne mƒõsto. Ale bacha ‚Äì konkurence nesp√≠ a chyba tƒõ m≈Ø≈æe st√°t v≈°echno.</p>
        
        <p><strong>Manu√°ln√≠ operace:</strong></p>
        <p>Zaƒçni t√≠m, ≈æe klikne≈° na ‚ÄûObrat babku‚Äú ‚Äì Ka≈æd√Ω ƒçlen gangu ti zvy≈°uje s√≠lu gangu a potom dost√°v√°≈° v√≠ce z manu√°ln√≠ch operac√≠!</p>
        
        <p><strong>Byznys a operace:</strong></p>
        <p>Investuj do skr√Ω≈°√≠ jako gar√°≈æe, motely nebo laborato≈ôe. Ka≈æd√Ω nov√Ω Byznys ti p≈ôinese novou operaci, naj√≠mej poskoky do Byznysu a generuj p≈ô√≠jem i kdy≈æ neklik√°≈°.</p>

        <button id="start-game-button">Zaƒç√≠t hr√°t</button>
    </div>

    <div id="game-container" class="hidden"> <!-- Initially hidden -->
        <!-- Panel s hern√≠mi statistikami -->
        <div class="bg-transparent p-4 text-center">
            <div id="money-display" class="text-6xl font-bold text-green-400 mb-4">$0</div>
            <div class="flex justify-center items-center gap-6 text-xl font-bold text-green-400">
                <div class="text-center flex items-center">
                    <i class="fas fa-clock mr-1 text-green-400"></i><span id="income-per-second-display">0/s</span>
                </div>
                <div class="text-center flex items-center">
                    <i class="fas fa-dumbbell mr-1 text-green-400"></i><span id="predicted-click-yield-display">+1 Kƒç/klik | Obrat babku</span>
                </div>
            </div>
            <div class="text-center text-green-400 text-xl mt-2">
                Celkov√° s√≠la Gangu: <span id="total-bot-strength-display" class="font-bold text-green-400">1</span>
            </div>
        </div>

        <!-- Sekce s tlaƒç√≠tkem operace a logem -->
        <div class="bg-transparent px-4 pb-4 flex flex-col flex-grow">
            <button id="click-button" class="btn-primary w-full text-2xl py-6 hover:scale-105 transform transition duration-200">
                OBRAT BABKU
            </button>
            <p id="operation-description" class="text-center text-zinc-400 mt-2 text-sm italic"></p>
            <div id="click-feedback" class="text-center text-lg font-bold mt-2 opacity-0 transition-opacity duration-500 ease-out"></div>

            <div id="operation-log-container" class="flex flex-col flex-grow mt-2">
                <div id="operation-log">
                </div>
            </div>
        </div>

        <!-- Z√°lo≈æky pro p≈ôep√≠n√°n√≠ -->
        <div class="flex justify-around border-b border-t border-green-600 mb-0 mt-0 overflow-x-auto">
            <button class="tab-button btn-secondary active-tab" data-tab="ai-bots">
                <i class="fas fa-users mr-1"></i> Gang
            </button>
            <button class="tab-button btn-secondary" data-tab="buildings">
                <i class="fas fa-building mr-1"></i> Byznys & Operace
            </button>
            <button class="tab-button btn-secondary" data-tab="achievements">
                <i class="fas fa-trophy mr-1"></i> Achievements
            </button>
        </div>

        <!-- Obsah z√°lo≈æek -->
        <div id="tab-content" class="flex-grow">
            <!-- Obsah z√°lo≈æky Gang -->
            <div id="ai-bots" class="tab-panel active">
                <p id="gang-description" class="text-zinc-400 text-sm p-4 pt-2">
                    Zde si naj√≠m√°te ƒçleny gangu, kte≈ô√≠ zvy≈°uj√≠ va≈°i Celkovou s√≠lu Gangu. Vy≈°≈°√≠ s√≠la Gangu v√°m umo≈æn√≠ prov√°dƒõt pokroƒçilej≈°√≠ operace a z√≠sk√°vat vy≈°≈°√≠ bonusy z manu√°ln√≠ch kliknut√≠.
                </p>
                <div id="ai-bots-list">
                    <!-- ƒålenov√© Gangu budou vykresleni zde pomoc√≠ JS -->
                </div>
            </div>

            <!-- Obsah z√°lo≈æky Byznys & Operace -->
            <div id="buildings" class="tab-panel hidden">
                <p id="business-description" class="text-zinc-400 text-sm p-4 pt-2">
                    Zde nakupujete budovy, kter√© odemykaj√≠ nov√© operace a umo≈æ≈àuj√≠ n√°bor zamƒõstnanc≈Ø pro pasivn√≠ p≈ô√≠jem. V√Ωzkum operac√≠ vylep≈°uje v√°≈° manu√°ln√≠ v√Ωnos.
                </p>
                <div id="buildings-list">
                    <!-- Budovy budou vykresleny zde pomoc√≠ JS -->
                </div>
            </div>

            <!-- Obsah z√°lo≈æky Achievements -->
            <div id="achievements" class="tab-panel hidden">
                <div id="achievements-list">
                    <!-- Achievements budou vykresleny zde pomoc√≠ JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Mini-game Modal -->
    <div id="mini-game-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-zinc-800 p-8 rounded-lg shadow-xl border border-lime-500 w-11/12 md:w-1/2 lg:w-1/3 text-center">
            <h3 class="text-2xl font-bold text-lime-400 mb-4">Hack the System!</h3>
            <p class="text-zinc-300 mb-4">Zadej k√≥d co nejrychleji!</p>
            <div id="code-display" class="bg-zinc-900 text-lime-300 font-mono text-xl p-4 rounded-md mb-4 select-all"></div>
            <input type="text" id="code-input" class="w-full p-3 rounded-md bg-zinc-700 text-zinc-100 placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-lime-500 mb-4" autocomplete="off" spellcheck="false">
            <div id="timer-display" class="text-lime-400 font-bold text-lg mb-4">ƒåas: 20.00s</div>
            <button id="mini-game-start-button" class="btn-primary w-full mb-2">Start Hacking</button>
            <button id="mini-game-cancel-button" class="btn-secondary w-full">Zru≈°it</button>
            <div id="mini-game-feedback" class="text-lg font-bold mt-4"></div>
        </div>
    </div>

    <script>
        // --- Definice dat hry ---

        // Definice v≈°ech typ≈Ø operac√≠
        // Ka≈æd√° operace m√° z√°kladn√≠ v√Ωnos a vy≈æaduje urƒçitou s√≠lu bot≈Ø
        // Nyn√≠ obsahuje tak√© vlastnosti pro v√Ωzkum: aktu√°ln√≠ √∫rove≈à, cenu a bonus
        const OPERATIONS_DEFINITIONS = [
            { // New initial operation
                name: "Obrat babku",
                description: "Odchyt si babku a seber ji co ma. Nizke riziko, svet je tvuj!",
                requiredStrength: 0,
                baseClickYield: 1, // Same base as Prodat d√°vku for simplicity in initial display
                initialResearchPrice: 0, // Not researchable
                researchYieldMultiplier: 1.0, // Not researchable
                outcomes: [
                    { chance: 0.15, yieldMultiplier: 0.00, message: "Dostal jsi na prdel a ≈°el jsi dom≈Ø!" },
                    { chance: 0.30, yieldMultiplier: 0.40, message: "Dostal jsi dvakrat holi pres zada, ale nemela sanci!" },
                    { chance: 0.34, yieldMultiplier: 0.75, message: "Babka ti dala co mƒõla.." },
                    { chance: 0.06, yieldMultiplier: 1.50, message: "Babka tƒõ omylem p≈ôeplatila!" },
                    { chance: 0.15, yieldMultiplier: 2.50, message: "Babka si nesla domu cely ducho! bingo more!" }
                ]
            },
            { // Moved "Prodat d√°vku" to index 1
                name: "Prodat d√°vku",
                description: "Rychl√Ω pouliƒçn√≠ k≈°eft za hotovost. N√≠zk√© riziko, n√≠zk√Ω v√Ωnos.",
                requiredStrength: 0,
                baseClickYield: 1,
                initialResearchPrice: 0,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Dostal jsi p≈ôes hubu a okradli tƒõ!" },
                    { chance: 0.20, yieldMultiplier: 0.33, message: "Kupuj√≠c√≠ smlouval, ale nƒõco z≈Østalo." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Bƒõ≈æn√Ω prodej probƒõhl hladce." },
                    { chance: 0.20, yieldMultiplier: 2.00, message: "Z√°kazn√≠k vzal v√≠c ne≈æ pl√°noval." },
                    { chance: 0.10, yieldMultiplier: 3.33, message: "VIP klient tƒõ p≈ôeplatil jako bl√°zen!" }
                ]
            },
            {
                name: "P≈ôedat bal√≠ƒçek",
                description: "P≈ôed√°vka z√°kazn√≠kovi z prvn√≠ v√°rky smƒõsi. V√Ωroba i v√Ωdej ruƒçnƒõ.",
                requiredStrength: 20,
                baseClickYield: 5,
                initialResearchPrice: 500,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Bal√≠ƒçek nƒõkdo zadr≈æel." },
                    { chance: 0.20, yieldMultiplier: 0.43, message: "P≈ôed√°vka probƒõhla, ale ne bez ztr√°t." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Standardn√≠ v√Ωmƒõna v klidu." },
                    { chance: 0.20, yieldMultiplier: 2.14, message: "P≈ôedal jsi extra d√°vku, a zaplatili!" },
                    { chance: 0.10, yieldMultiplier: 4.29, message: "Obchodn√≠ partner chtƒõl celou z√°sobu!" }
                ]
            },
            {
                name: "Distribuovat l√°tku",
                description: "Mobiln√≠ distribuce v r≈Øzn√Ωch ƒçtvrt√≠ch, ƒçast√© p≈ôesuny a vy≈°≈°√≠ dosah.",
                requiredStrength: 100,
                baseClickYield: 25,
                initialResearchPrice: 2000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Polda tƒõ stopl na cestƒõ." },
                    { chance: 0.20, yieldMultiplier: 0.40, message: "Ztr√°ty p≈ôi p≈ôevozu ‚Äì nƒõco zbylo." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Z√°silka dorazila bez probl√©m≈Ø." },
                    { chance: 0.20, yieldMultiplier: 2.00, message: "Koupili v√≠c, ne≈æ mƒõli v √∫myslu." },
                    { chance: 0.10, yieldMultiplier: 4.00, message: "Z√°silka ≈°la p≈ôes velkoobchod, jackpot!" }
                ]
            },
            {
                name: "Z√°sobit lok√°ln√≠ dealery", // New name for index 3
                description: "ƒå√°st z√°silek miz√≠ ‚Äûv pr√°dle‚Äú. Pen√≠ze se vrac√≠ ƒçist√© a bezpeƒçn√©.",
                requiredStrength: 500,
                baseClickYield: 100,
                initialResearchPrice: 10000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Jeden z dealer≈Ø tƒõ zradil." },
                    { chance: 0.20, yieldMultiplier: 0.70, message: "P√°r lid√≠ tƒõ zklamalo, ale nƒõco se prodalo." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "S√≠≈• fungovala hladce." },
                    { chance: 0.20, yieldMultiplier: 2.30, message: "Dealersk√° s√≠≈• p≈ôekvapila popt√°vkou." },
                    { chance: 0.10, yieldMultiplier: 4.50, message: "Masivn√≠ v√Ωkup ‚Äì nemohli se naba≈æit." }
                ]
            },
            {
                name: "P≈ôepravit p≈ôes hranici", // New name for index 4
                description: "Kvalitn√≠ sklize≈à se rychle prod√°v√° m√≠stn√≠m dealer≈Øm. St√°l√Ω v√Ωnos.",
                requiredStrength: 2500,
                baseClickYield: 400,
                initialResearchPrice: 50000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Celn√≠ci tƒõ naƒçapali." },
                    { chance: 0.20, yieldMultiplier: 0.50, message: "Ztr√°ty na hranici, ale nƒõco pro≈°lo." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Pr≈Øjezd √∫spƒõ≈°n√Ω, nikdo si niƒçeho nev≈°iml." },
                    { chance: 0.20, yieldMultiplier: 2.50, message: "Pro≈°els to s pomoc√≠ kontaktu." },
                    { chance: 0.10, yieldMultiplier: 5.00, message: "Letadlem jsi to dostal a≈æ k prezidentovi." }
                ]
            },
            {
                name: "Z√°sobit noƒçn√≠ klub", // New name for index 5
                description: "V√Ωroba ƒçist√© syntetiky a jej√≠ distribuce do mƒõsta skrze s√≠≈• kur√Ωr≈Ø.",
                requiredStrength: 12000,
                baseClickYield: 1500,
                initialResearchPrice: 250000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Majitel klubu tƒõ podrazil." },
                    { chance: 0.20, yieldMultiplier: 0.60, message: "Prodali, ale nebyla sobota." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "P√°teƒçn√≠ veƒçer, dobr√Ω obrat." },
                    { chance: 0.20, yieldMultiplier: 2.50, message: "Z√°silka padla na hlavn√≠ akci mƒõs√≠ce." },
                    { chance: 0.10, yieldMultiplier: 6.00, message: "Z√°soboval jsi festival, ≈°√≠len√© zisky!" }
                ]
            },
            {
                name: "Prod√°vat novou smƒõs", // Renamed operation
                description: "P≈ôipraven√© z√°silky se p≈ôed√°vaj√≠ velk√Ωm odbƒõratel≈Øm. Vysok√Ω obrat.",
                requiredStrength: 60000,
                baseClickYield: 6000,
                initialResearchPrice: 1000000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Test dopadl tragicky, ztr√°ta." },
                    { chance: 0.20, yieldMultiplier: 0.30, message: "Slab√° odezva, neuchytilo se." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Funguje to, z√°kladn√≠ popt√°vka vytvo≈ôena." },
                    { chance: 0.20, yieldMultiplier: 2.00, message: "Hit u men≈°√≠ch skupin, hype stoup√°." },
                    { chance: 0.10, yieldMultiplier: 4.00, message: "Z√°zraƒçn√° smƒõs ‚Äì tot√°ln√≠ ≈°√≠lenstv√≠!" }
                ]
            },
            {
                name: "P≈ôipravit d√°vku pro export", // New name for index 7
                description: "Bal√≠ƒçky miz√≠ v kufrech turist≈Ø. ƒåist√Ω export mimo mƒõsto.",
                requiredStrength: 250000,
                baseClickYield: 24000,
                initialResearchPrice: 5000000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Laborato≈ô vybuchla, ≈°patn√© slo≈æen√≠." },
                    { chance: 0.20, yieldMultiplier: 0.50, message: "Z√°silka nepro≈°la kvalitou." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Standardn√≠ d√°vka p≈ôipraven√°." },
                    { chance: 0.20, yieldMultiplier: 2.00, message: "Speci√°ln√≠ objedn√°vka pro velk√Ω trh." },
                    { chance: 0.10, yieldMultiplier: 5.00, message: "Pr√©miov√° d√°vka pro zahraniƒçn√≠ mafii!" }
                ]
            },
            {
                name: "Uzav≈ô√≠t digit√°ln√≠ obchod", // New name for index 8
                description: "Distribuce velk√Ωch objem≈Ø s ochranou, rychl√° obr√°tka.",
                requiredStrength: 1000000,
                baseClickYield: 100000,
                initialResearchPrice: 25000000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Scam ‚Äì klient zmizel." },
                    { chance: 0.20, yieldMultiplier: 0.60, message: "Men≈°√≠ p≈ôevod, klient byl opatrn√Ω." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Prodej p≈ôes darknet √∫spƒõ≈°n√Ω." },
                    { chance: 0.20, yieldMultiplier: 2.50, message: "Obchodn√≠ s√≠≈• tƒõ doporuƒçila d√°l." },
                    { chance: 0.10, yieldMultiplier: 6.00, message: "Viral hit ‚Äì prodal jsi cel√©mu f√≥ru!" }
                ]
            },
            {
                name: "Z√°silka pro syndik√°t", // New name for index 9
                description: "V√Ωroba a rozes√≠lka p≈ôes kontakty v cel√©m st√°tƒõ. Obrovsk√© v√Ωnosy.",
                requiredStrength: 4000000,
                baseClickYield: 400000,
                initialResearchPrice: 100000000,
                researchYieldMultiplier: 1.10,
                outcomes: [
                    { chance: 0.10, yieldMultiplier: 0.00, message: "Syndik√°t tƒõ za≈°krtnul ‚Äì chyba!" },
                    { chance: 0.20, yieldMultiplier: 0.40, message: "Podhodnotili z√°silku, ƒç√°st odm√≠tli." },
                    { chance: 0.40, yieldMultiplier: 1.00, message: "Zak√°zka dorazila dle oƒçek√°v√°n√≠." },
                    { chance: 0.20, yieldMultiplier: 3.00, message: "Vysok√Ω rating, vzali v√≠c." },
                    { chance: 0.10, yieldMultiplier: 7.00, message: "Odmƒõna za loajalitu ‚Äì odkup cel√©ho skladu!" }
                ]
            }
        ];

        // Definice v≈°ech typ≈Ø Internet Bandwidth (nyn√≠ Gang members)
        // Ka≈æd√Ω typ m√° atribut s√≠ly gangu
        const AI_BOT_DEFINITIONS = [ // Changed context to Gang members in comments
            { name: "Bƒõ≈æec s batohem", operationIndex: 1, initialPrice: 10, clickYieldIncrease: 1, strength: 1 }, // operationIndex shifted to 1
            { name: "N√°vazn√° linka", operationIndex: 2, initialPrice: 400, clickYieldIncrease: 5, strength: 5 }, // operationIndex shifted
            { name: "Ruƒçn√≠ baliƒçka", operationIndex: 3, initialPrice: 8000, clickYieldIncrease: 25, strength: 25 }, // operationIndex shifted
            { name: "Kur√Ωr na motorce", operationIndex: 4, initialPrice: 150000, clickYieldIncrease: 100, strength: 100 }, // operationIndex shifted
            { name: "Logistick√Ω Expert", operationIndex: 5, initialPrice: 3000000, clickYieldIncrease: 400, strength: 400 }, // Renamed from Rychl√Ω mix√©r, operationIndex shifted
            { name: "Pouliƒçn√≠ s√≠≈•", operationIndex: 6, initialPrice: 60000000, clickYieldIncrease: 1500, strength: 1500 }, // operationIndex shifted
            { name: "D√°vkovaƒç", operationIndex: 7, initialPrice: 1200000000, clickYieldIncrease: 6000, strength: 6000 }, // operationIndex shifted
            { name: "Turbo rozvoz", operationIndex: 8, initialPrice: 25000000000, clickYieldIncrease: 24000, strength: 24000 }, // operationIndex shifted
            { name: "Automatick√Ω dispenser", operationIndex: 9, initialPrice: 500000000000, clickYieldIncrease: 100000, strength: 100000 }, // operationIndex shifted
            { name: "Pokroƒçil√° v√Ωroba", operationIndex: 10, initialPrice: 10000000000000, clickYieldIncrease: 400000, strength: 400000 } // operationIndex shifted (index 10 for consistency)
        ];

        // Definice Budovy, kter√© odemykaj√≠ operace a zamƒõstnance
        const BUILDING_DEFINITIONS = [
            { id: "bytNaDubine", name: "Byt na Dubinƒõ", price: 50, unlockedOperationIndex: 1, employeeName: "Pouliƒçn√≠ dealer", employeeInitialYield: 1, employeeInitialPrice: 25 }, // unlockedOperationIndex shifted to 1
            { id: "dilnaPodzemi", name: "D√≠lna v podzem√≠", price: 250, unlockedOperationIndex: 2, employeeName: "M√≠chaƒç l√°tek", employeeInitialYield: 5, employeeInitialPrice: 100 }, // unlockedOperationIndex shifted
            { id: "karavan", name: "Karavan", price: 1500, unlockedOperationIndex: 3, employeeName: "Baliƒç", employeeInitialYield: 25, employeeInitialPrice: 500 }, // unlockedOperationIndex shifted
            { id: "skladPristavu", name: "Sklad v p≈ô√≠stavu", price: 9000, unlockedOperationIndex: 4, employeeName: "Kur√Ωr", employeeInitialYield: 100, employeeInitialPrice: 2000 }, // unlockedOperationIndex shifted
            { id: "pradelna", name: "Pr√°delna", price: 45000, unlockedOperationIndex: 5, employeeName: "Ochranka", employeeInitialYield: 400, employeeInitialPrice: 8000 }, // unlockedOperationIndex shifted
            { id: "zchradlyMotel", name: "Zch√°tral√Ω motel", price: 180000, unlockedOperationIndex: 6, employeeName: "Distribuƒçn√≠ expert", employeeInitialYield: 1500, employeeInitialPrice: 30000 }, // unlockedOperationIndex shifted
            { id: "sklenikHorach", name: "Sklen√≠k v hor√°ch", price: 900000, unlockedOperationIndex: 7, employeeName: "Tich√Ω chemik", employeeInitialYield: 6000, employeeInitialPrice: 120000 }, // unlockedOperationIndex shifted
            { id: "chemickaLaborator", name: "Chemick√° laborato≈ô", price: 4500000, unlockedOperationIndex: 8, employeeName: "Supervisior d√≠lny", employeeInitialYield: 24000, employeeInitialPrice: 480000 }, // unlockedOperationIndex shifted
            { id: "opancerovanySklad", name: "Opanc√©≈ôovan√Ω sklad", price: 18000000, unlockedOperationIndex: 9, employeeName: "ƒåistiƒç stop", employeeInitialYield: 100000, employeeInitialPrice: 2000000 }, // unlockedOperationIndex shifted
            { id: "megaFarma", name: "Mega farma", price: 100000000, unlockedOperationIndex: 10, employeeName: "Koordin√°tor dod√°vky", employeeInitialYield: 400000, employeeInitialPrice: 8000000 } // unlockedOperationIndex shifted (index 10)
        ];

        // Definice bonus≈Ø efektivity pro zamƒõstnance
        // Bonusy jsou nyn√≠ 100% (tj. 1.0) p≈ôi dosa≈æen√≠ konkr√©tn√≠ch poƒçt≈Ø
        const EMPLOYEE_EFFICIENCY_BONUSES = [
            { count: 5, bonus: 1.00 }, // 100 % bonus p≈ôi 5 zamƒõstnanc√≠ch
            { count: 25, bonus: 1.00 }, // 100 % bonus p≈ôi 25 zamƒõstnanc√≠ch
            { count: 100, bonus: 1.00 } // 100 % bonus p≈ôi 100 zamƒõstnanc√≠ch
        ];

        // Definice achievement≈Ø s odmƒõnami
        const ACHIEVEMENTS_DEFINITIONS = [
            { id: 'click20', description: "Klikni 20x", check: (state) => state.totalClicks >= 20, reward: 50 },
            { id: 'buy1Runner', description: "Kup 1 Bƒõ≈æec s batohem", check: (state) => state.aiBots[0].count >= 1, reward: 100 },
            { id: 'buy10Runners', description: "Kup 10 Bƒõ≈æc≈Ø s batohem", check: (state) => state.aiBots[0].count >= 10, reward: 500 },
            { id: 'buyFirstBuilding', description: "Kup Byt na Dubinƒõ", check: (state) => state.buildings[0].isBought, reward: 1000 }, // Updated name
            { id: 'buy1StreetDealer', description: "Kup 1 zamƒõstnance (Pouliƒçn√≠ dealer)", check: (state) => state.buildings[0].employeeCount >= 1, reward: 200 },
            { id: 'buy25StreetDealers', description: "Kup 25 Pouliƒçn√≠ch dealer≈Ø (bonus efektivity)", check: (state) => gameState.buildings[0].employeeCount >= 25, reward: 2000 },
            { id: 'buySecondBuilding', description: "Kup D√≠lna v podzem√≠", check: (state) => state.buildings[1].isBought, reward: 5000 },
            { id: 'buy1FollowUpLine', description: "Kup 1 N√°vazn√° linka", check: (state) => state.aiBots[1].count >= 1, reward: 1000 },
            { id: 'buy50StreetDealers', description: "Kup 50 Pouliƒçn√≠ch dealer≈Ø", check: (state) => gameState.buildings[0].employeeCount >= 50, reward: 4000 },
            { id: 'buy10Mixers', description: "Kup 10 M√≠chaƒç≈Ø l√°tek", check: (state) => state.buildings[1].employeeCount >= 10, reward: 3000 },
            { id: 'buyThirdBuilding', description: "Kup Karavan", check: (state) => state.buildings[2].isBought, reward: 10000 },
            { id: 'buy100StreetDealers', description: "Kup 100 Pouliƒçn√≠ch dealer≈Ø", check: (state) => gameState.buildings[0].employeeCount >= 100, reward: 8000 },
            { id: 'buy25Mixers', description: "Kup 25 M√≠chaƒç≈Ø l√°tek", check: (state) => state.buildings[1].employeeCount >= 25, reward: 7000 },
            { id: 'buyFourthBuilding', description: "Kup Sklad v p≈ô√≠stavu", check: (state) => state.buildings[3].isBought, reward: 20000 },
            { id: 'buy5ManualPackers', description: "Kup 5 Ruƒçn√≠ch baliƒçek", check: (state) => state.aiBots[2].count >= 5, reward: 15000 },
            { id: 'buy50Packers', description: "Kup 50 Baliƒç≈Ø", check: (state) => state.buildings[2].employeeCount >= 50, reward: 18000 },
            { id: 'buyFifthBuilding', description: "Kup Pr√°delna", check: (state) => state.buildings[4].isBought, reward: 50000 },
            { id: 'buy100Packers', description: "Kup 100 Baliƒç≈Ø", check: (state) => state.buildings[2].employeeCount >= 100, reward: 40000 },
            { id: 'buySixthBuilding', description: "Kup Zch√°tral√Ω motel", check: (state) => state.buildings[5].isBought, reward: 100000 },
            { id: 'completeMegaFarma', description: "Kup Mega farma", check: (state) => state.buildings[9].isBought, reward: 1000000 }
        ];

        // --- Stav hry ---
        let gameState = {
            money: 0, // Aktu√°ln√≠ pen√≠ze hr√°ƒçe
            totalClicks: 0, // Celkov√Ω poƒçet manu√°ln√≠ch kliknut√≠
            activeOperationIndex: 0, // Index aktu√°lnƒõ aktivn√≠ operace (zaƒç√≠n√° na "Obrat babku")
            // Mapa operac√≠ s informac√≠, zda jsou odemƒçeny a jejich aktu√°ln√≠ stav v√Ωzkumu
            operations: OPERATIONS_DEFINITIONS.map((op, index) => ({
                ...op,
                // Obrat babku (index 0) je odemƒçen√° na zaƒç√°tku, ostatn√≠ ne
                unlocked: index === 0, 
                currentResearchLevel: 0, // Poƒç√°teƒçn√≠ √∫rove≈à v√Ωzkumu pro ka≈ædou operaci
                currentResearchPrice: op.initialResearchPrice, // Aktu√°ln√≠ cena v√Ωzkumu pro tuto operaci
                currentBaseClickYield: op.baseClickYield // Aktu√°ln√≠ z√°kladn√≠ v√Ωnos, ovlivnƒõn√Ω v√Ωzkumem
            })),
            // Mapa ƒçlen≈Ø Gangu s poƒçtem, aktu√°ln√≠ cenou a z√°kladn√≠mi definicemi
            aiBots: AI_BOT_DEFINITIONS.map(bot => ({ ...bot, count: 0, currentPrice: bot.initialPrice })),
            // Mapa Budovy
            buildings: BUILDING_DEFINITIONS.map((building, index) => ({
                ...building,
                isBought: false, // Zda byla budova zakoupena
                employeeCount: 0, // Poƒçet najat√Ωch zamƒõstnanc≈Ø
                employeeCurrentPrice: building.employeeInitialPrice, // Aktu√°ln√≠ cena pro najmut√≠ dal≈°√≠ho zamƒõstnance
                employeeTotalYield: 0, // Celkov√Ω v√Ωnos od zamƒõstnanc≈Ø (dynamicky poƒç√≠t√°no)
                availableToBuy: index === 0, // Jen prvn√≠ budova je na zaƒç√°tku k dispozici k n√°kupu
                strengthBonus: 0 // S√≠la p≈ôidan√° po zakoupen√≠ budovy
            })),
            // Mapa achievement≈Ø s informac√≠, zda byly splnƒõny a zda byla odmƒõna vybr√°na
            achievements: ACHIEVEMENTS_DEFINITIONS.map(a => ({ ...a, completed: false, rewardClaimed: false })),
            totalBotStrength: 1, // Celkov√° s√≠la Gangu (vƒçetnƒõ bonus≈Ø z vyzkouman√Ωch operac√≠/budov) - Z√°kladn√≠ hodnota 1
            operationLog: [], // Log posledn√≠ch operac√≠
            gameOver: false, // Zda hra skonƒçila
            // Nov√© flagy pro trval√© odemƒçen√≠ z√°lo≈æek
            isGangTabUnlocked: false,
            isBusinessTabUnlocked: false,
            isAchievementsTabUnlocked: false
        };

        // --- DOM Elementy ---
        const moneyDisplay = document.getElementById('money-display');
        const incomePerSecondDisplay = document.getElementById('income-per-second-display');
        const predictedClickYieldDisplay = document.getElementById('predicted-click-yield-display'); // Renamed element
        const totalBotStrengthDisplay = document.getElementById('total-bot-strength-display'); // Corrected typo
        const clickButton = document.getElementById('click-button');
        const operationDescriptionDisplay = document.getElementById('operation-description'); // Added for operation description
        const aiBotsList = document.getElementById('ai-bots-list');
        const buildingsList = document.getElementById('buildings-list');
        const achievementsList = document.getElementById('achievements-list');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabPanels = document.querySelectorAll('.tab-panel');
        const clickFeedbackDisplay = document.getElementById('click-feedback');
        const operationLogElement = document.getElementById('operation-log');
        const welcomeModal = document.getElementById('welcome-modal'); // New: Welcome Modal
        const startGameButton = document.getElementById('start-game-button'); // New: Start Game Button
        const gameContainer = document.getElementById('game-container'); // New: Game Container

        // Mini-game DOM elementy
        const miniGameModal = document.getElementById('mini-game-modal');
        const codeDisplay = document.getElementById('code-display');
        const codeInput = document.getElementById('code-input');
        const timerDisplay = document.getElementById('timer-display');
        const miniGameStartButton = document.getElementById('mini-game-start-button');
        const miniGameCancelButton = document.getElementById('mini-game-cancel-button');
        const miniGameFeedback = document.getElementById('mini-game-feedback'); 

        // Mini-game state variables
        let currentResearchOperationIndex = -1; // Store the index of the operation currently being researched
        const MINI_GAME_CODE = "Odhlasovani z verejnych prostor"; // Fixed text for mini-game
        let miniGameCode = MINI_GAME_CODE; // Initialize with the fixed code
        let miniGameTimer;
        let miniGameTimeRemaining = 20; // seconds
        const MINI_GAME_DURATION = 20; // seconds

        // --- Pomocn√© funkce ---

        /**
         * Form√°tuje ƒç√≠slo jako mƒõnu, p≈ôid√°v√° zkratky (K, M, B, T atd.) a pou≈æ√≠v√° "Kƒç".
         * @param {number} amount ƒå√°stka k form√°tov√°n√≠.
         * @returns {string} Zform√°tovan√Ω ≈ôetƒõzec mƒõny.
         */
        function formatCurrency(amount) {
            // Handle zero explicitly
            if (amount === 0) return `0 Kƒç`;
            // Handle positive amounts less than 1, showing as "1 Kƒç"
            if (amount > 0 && amount < 1) return `1 Kƒç`;

            const absoluteAmount = Math.abs(amount); // Use absolute value for formatting numbers
            
            // Format large numbers with abbreviations
            if (absoluteAmount < 1000) return `${Math.round(absoluteAmount)} Kƒç`;
            
            const units = ["", "K", "M", "B", "T", "Qa", "Qi", "Sx", "Sp", "Oc", "No", "Dc"];
            const tier = Math.floor(Math.log10(absoluteAmount) / 3);
            const scaled = absoluteAmount / Math.pow(1000, tier);
            
            return `${scaled.toFixed(1)} ${units[tier]}Kƒç`;
        }


        /**
         * Generuje SVG ikony hlavy na z√°kladƒõ poƒçtu, inspirov√°no ≈ô√≠msk√Ωmi ƒç√≠slicemi.
         * Pou≈æito pro ƒçleny Gangu i zamƒõstnance.
         * @param {number} count Poƒçet entit (ƒçlen≈Ø gangu/zamƒõstnanc≈Ø).
         * @returns {string} HTML ≈ôetƒõzec s ikonami hlav.
         */
        function getHeadIcon(count) {
            const svgBase = `<svg class="bot-head-icon {color}" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.38 0 2.5 1.12 2.5 2.5S13.38 10 12 10 9.5 8.88 9.5 7.5 10.62 5 12 5zm-3.5 6h7c.83 0 1.5.67 1.5 1.5v3.5h-10V12.5c0-.83.67-1.5 1.5-1.5z"/></svg>`;
            let icons = '';
            let remainingCount = count;

            // Prioritn√≠ p≈ôid√°v√°n√≠ ikon od nejvƒõt≈°√≠ch hodnot
            const iconMap = [
                { value: 100, color: 'purple' },
                { value: 25, color: 'blue' },
                { value: 5, color: 'green' },
                { value: 1, color: 'white' }
            ];

            for (const { value, color } of iconMap) {
                while (remainingCount >= value) {
                    icons += svgBase.replace('{color}', color);
                    remainingCount -= value;
                }
            }
            return icons;
        }

        /**
         * Vypoƒç√≠t√° celkovou s√≠lu Gangu v≈°ech zakoupen√Ωch ƒçlen≈Ø Gangu a bonus≈Ø z koupen√Ωch budov.
         * @returns {number} Celkov√° s√≠la Gangu.
         */
        function calculateTotalBandwidth() { // Renamed internally to reflect 'S√≠la Gangu'
            let strengthFromBots = gameState.aiBots.reduce((sum, bot) => sum + (bot.count * bot.strength), 0);
            let strengthFromBuildings = gameState.buildings.reduce((sum, building) => sum + building.strengthBonus, 0);
            return strengthFromBots + strengthFromBuildings + 1; // Add base 1 for Celkov√° s√≠la Gangu
        }

        /**
         * Vypoƒç√≠t√° celkov√Ω v√Ωnos za jedno manu√°ln√≠ kliknut√≠ pro aktivn√≠ operaci (z√°kladn√≠, p≈ôed aplikac√≠ n√°hody).
         * Tato funkce je prim√°rnƒõ pro zobrazen√≠ "V√Ωnos/klik" v UI.
         * @returns {number} Celkov√Ω z√°kladn√≠ p≈ô√≠jem za jedno manu√°ln√≠ kliknut√≠.
         */
        function calculateClickYield() {
            const activeOp = gameState.operations[gameState.activeOperationIndex];
            const hasEnoughBandwidth = gameState.totalBotStrength >= activeOp.requiredStrength;

            let currentYield = activeOp.currentBaseClickYield;

            if (hasEnoughBandwidth) {
                gameState.aiBots.forEach(bot => {
                    // Check if bot's operation index matches active operation index
                    // This ensures bot yield is only added if compatible with the currently selected manual operation
                    // if (bot.operationIndex === gameState.activeOperationIndex) { // Removed this condition as per user's earlier request that AI bots scale all manual operations by strength
                        currentYield += bot.count * bot.clickYieldIncrease;
                    // }
                });
            }
            return currentYield;
        }

        /**
         * Vypoƒç√≠t√° celkov√Ω pasivn√≠ p≈ô√≠jem za sekundu od zamƒõstnanc≈Ø.
         * @returns {number} Celkov√Ω pasivn√≠ p≈ô√≠jem za sekundu.
         */
        function calculatePassiveIncome() {
            let totalIncome = 0;

            // P≈ô√≠jem od zamƒõstnanc≈Ø (v√°zan√Ωch na zakoupen√© budovy)
            gameState.buildings.forEach(building => {
                if (building.isBought && building.employeeCount > 0) {
                    let efficiencyBonusMultiplier = 1; // Start with 1 (no bonus)
                    // Najde nejvy≈°≈°√≠ dosa≈æen√Ω bonus efektivity
                    for (const bonus of EMPLOYEE_EFFICIENCY_BONUSES) {
                        if (building.employeeCount >= bonus.count) {
                            efficiencyBonusMultiplier = (1 + bonus.bonus); // P≈ôid√° 100% bonus (tj. * 2)
                        }
                    }
                    totalIncome += building.employeeCount * building.employeeInitialYield * efficiencyBonusMultiplier;
                }
            });

            return totalIncome;
        }

        /**
         * Aktualizuje v≈°echny UI elementy s aktu√°ln√≠m stavem hry.
         */
        function updateUI() {
            gameState.totalBotStrength = calculateTotalBandwidth(); // Aktualizuje celkovou s√≠lu Gangu
            moneyDisplay.textContent = formatCurrency(gameState.money);
            incomePerSecondDisplay.textContent = `+${formatCurrency(calculatePassiveIncome())}/s`;
            // Display predicted click yield and active operation name
            predictedClickYieldDisplay.textContent = `+${formatCurrency(calculateClickYield())}/klik | ${gameState.operations[gameState.activeOperationIndex].name}`; // Changed / to |
            totalBotStrengthDisplay.textContent = gameState.totalBotStrength; // Display Celkov√° s√≠la Gangu

            // Automaticky nastav√≠ nejpokroƒçilej≈°√≠ odemƒçenou operaci jako aktivn√≠
            let highestUnlockedOpIndex = 0;
            for (let i = gameState.operations.length - 1; i >= 0; i--) {
                if (gameState.operations[i].unlocked) {
                    highestUnlockedOpIndex = i;
                    break;
                }
            }
            gameState.activeOperationIndex = highestUnlockedOpIndex;
            const activeOp = gameState.operations[gameState.activeOperationIndex];
            clickButton.textContent = activeOp.name.toUpperCase(); // Text tlaƒç√≠tka velk√Ωmi p√≠smeny
            operationDescriptionDisplay.textContent = activeOp.description; // Display operation description

            renderAIBots(); // Vykresl√≠ seznam ƒçlen≈Ø Gangu
            renderBuildings(); // Vykresl√≠ seznam budov
            checkAchievements(); // Zkontroluje splnƒõn√≠ achievement≈Ø P≈òED vykreslen√≠m
            renderAchievements(); // Vykresl√≠ seznam achievement≈Ø
            renderOperationLog(); // Vykresl√≠ log operac√≠
            updateTabStates(); // Aktualizace stavu z√°lo≈æek
        }

        /**
         * Zpracuje ud√°lost manu√°ln√≠ho kliknut√≠.
         */
        function handleClick() {
            if (gameState.gameOver) return;
            gameState.totalClicks++;

            const activeOp = gameState.operations[gameState.activeOperationIndex];
            const hasEnoughBandwidth = gameState.totalBotStrength >= activeOp.requiredStrength;

            // Calculate the base yield before applying random outcome multiplier
            let baseYield = activeOp.currentBaseClickYield; // Initialized baseYield
            if (hasEnoughBandwidth) {
                gameState.aiBots.forEach(bot => {
                    baseYield += bot.count * bot.clickYieldIncrease; // Correctly add to baseYield
                });
            }

            // Determine the outcome based on chances
            const rand = Math.random(); // Generates a random number between 0 (inclusive) and 1 (exclusive)
            let cumulativeChance = 0;
            let chosenOutcome = null;

            // Iterate through outcomes to find which one applies
            for (const outcome of activeOp.outcomes) {
                cumulativeChance += outcome.chance;
                if (rand < cumulativeChance) {
                    chosenOutcome = outcome;
                    break;
                }
            }

            // If no outcome was chosen (shouldn't happen if chances sum to 1.0), default to 100% yield
            if (!chosenOutcome) {
                chosenOutcome = { yieldMultiplier: 1.00, message: "Nezn√°m√Ω v√Ωsledek operace.", chance: 1.00 }; // Ensure chance is defined for safety
            }

            // Apply the yield multiplier from the chosen outcome
            let finalYield = baseYield * chosenOutcome.yieldMultiplier;

            // Ensure any positive yield is at least 1, but 0 remains 0 for failures
            if (chosenOutcome.yieldMultiplier > 0 && finalYield > 0 && finalYield < 1) { // Added finalYield > 0 to ensure it's not a true 0
                finalYield = 1;
            } else {
                finalYield = Math.floor(finalYield); // Apply floor for yields >= 1 or 0
            }

            gameState.money += finalYield;

            // Add to operation log as an object
            gameState.operationLog.push({
                type: 'action',
                message: chosenOutcome.message,
                amount: finalYield,
                isLoss: chosenOutcome.yieldMultiplier === 0
            });
            
            if (gameState.operationLog.length > 10) {
                gameState.operationLog.shift();
            }

            // Display click feedback
            let feedbackText = `${formatCurrency(finalYield)}`;
            clickFeedbackDisplay.textContent = feedbackText;
            clickFeedbackDisplay.style.color = chosenOutcome.yieldMultiplier > 0 ? '#4ade80' : '#ef4444'; // Green for gain, Red for loss
            clickFeedbackDisplay.style.opacity = '1';
            setTimeout(() => {
                clickFeedbackDisplay.style.opacity = '0';
            }, 700);

            updateUI();
        }

        /**
         * Updates the disabled state of tab buttons based on game conditions.
         */
        function updateTabStates() {
            // Gang tab (index 0)
            const gangTabButton = tabButtons[0];
            // If already unlocked, keep it unlocked
            if (!gameState.isGangTabUnlocked) {
                if (gameState.money >= 10) {
                    gameState.isGangTabUnlocked = true;
                }
            }
            gangTabButton.disabled = !gameState.isGangTabUnlocked;

            // Byznys & Operace tab (index 1)
            const businessTabButton = tabButtons[1];
            // If already unlocked, keep it unlocked
            if (!gameState.isBusinessTabUnlocked) {
                // Now only checks money >= 10
                if (gameState.money >= 10) {
                    gameState.isBusinessTabUnlocked = true;
                }
            }
            businessTabButton.disabled = !gameState.isBusinessTabUnlocked;

            // Achievements tab (index 2)
            const achievementsTabButton = tabButtons[2];
            // If already unlocked, keep it unlocked
            if (!gameState.isAchievementsTabUnlocked) {
                // Check if the first achievement (index 0, 'click20') is completed
                if (gameState.achievements[0].completed) {
                    gameState.isAchievementsTabUnlocked = true;
                }
            }
            achievementsTabButton.disabled = !gameState.isAchievementsTabUnlocked;

            // Logic to switch active tab if current active becomes disabled
            let activeTabElement = document.querySelector('.tab-button.active-tab');
            let activeTabPanelElement = activeTabElement ? document.getElementById(activeTabElement.dataset.tab) : null;

            if (!activeTabElement || activeTabElement.disabled) { // If no active tab or current active tab is disabled
                // First, hide all panels
                tabPanels.forEach(panel => panel.classList.add('hidden'));
                tabButtons.forEach(btn => btn.classList.remove('active-tab'));

                // Find the first non-disabled tab and activate it
                let newActiveTabFound = false;
                for (let i = 0; i < tabButtons.length; i++) {
                    if (!tabButtons[i].disabled) {
                        tabButtons[i].classList.add('active-tab');
                        document.getElementById(tabButtons[i].dataset.tab).classList.remove('hidden');
                        newActiveTabFound = true;
                        break;
                    }
                }
                // If no non-disabled tab is found, default to the first tab (even if disabled) and show its content
                if (!newActiveTabFound && tabButtons.length > 0) {
                    tabButtons[0].classList.add('active-tab');
                    document.getElementById(tabButtons[0].dataset.tab).classList.remove('hidden');
                }
            } else {
                // If there's already an active and enabled tab, ensure its content is shown
                activeTabPanelElement.classList.remove('hidden');
            }
        }

        /**
         * Vykresl√≠ seznam ƒçlen≈Ø Gangu do UI.
         */
        function renderAIBots() {
            aiBotsList.innerHTML = '';
            let nextUnboughtBotDisplayed = false;

            gameState.aiBots.forEach((bot, index) => {
                const isBought = bot.count > 0;
                const isOperationUnlocked = gameState.operations[bot.operationIndex].unlocked;
                const canBuy = gameState.money >= bot.currentPrice && isOperationUnlocked;

                // Display if bought OR if it's the next unbought bot in sequence
                // nextUnboughtBotDisplayed ensures only ONE unbought bot is shown at a time
                const shouldDisplay = isBought || (!nextUnboughtBotDisplayed && !isBought);
                
                if (shouldDisplay) {
                    const botElement = document.createElement('div');
                    botElement.className = 'item-card';
                    botElement.innerHTML = `
                        <div class="item-card-details">
                            <div class="item-card-title">
                                <span>${bot.name} (${bot.count}) ${getHeadIcon(bot.count)}</span>
                                <span class="price">${formatCurrency(bot.currentPrice)}</span>
                            </div>
                            <div class="item-card-stats">
                                S√≠la Gangu: +${bot.strength}
                                ${!isOperationUnlocked ? `<br><span class="text-red-400"> (Odemkne se s "${OPERATIONS_DEFINITIONS[bot.operationIndex].name}")</span>` : ''}
                            </div>
                        </div>
                        <button class="btn-primary buy-ai-bot" data-index="${index}" ${!canBuy ? 'disabled' : ''}>Koupit</button>
                    `;
                    aiBotsList.appendChild(botElement);

                    if (!isBought) { // If this bot is not bought, it means it's the next unbought one we just displayed
                        nextUnboughtBotDisplayed = true;
                    }
                }
            });

            document.querySelectorAll('.buy-ai-bot').forEach(button => {
                button.onclick = (event) => buyAIBot(parseInt(event.target.dataset.index));
            });
        }

        /**
         * Koup√≠ ƒçlena Gangu.
         * @param {number} index Index typu ƒçlena Gangu, kter√Ω se m√° koupit.
         */
        function buyAIBot(index) {
            if (gameState.gameOver) return;
            const bot = gameState.aiBots[index];
            const isOperationUnlocked = gameState.operations[bot.operationIndex].unlocked;

            if (gameState.money >= bot.currentPrice && isOperationUnlocked) {
                gameState.money -= bot.currentPrice;
                bot.count++;
                
                gameState.operationLog.push({
                    type: 'gang',
                    message: `Koupen ${bot.name} (celkem ${bot.count}).`,
                    amount: -Math.round(bot.currentPrice / 1.15), // Log original price for consistency, now negative
                    isLoss: false // This refers to action outcome loss, not financial loss
                });
                
                bot.currentPrice *= 1.15;
                updateUI();
            }
        }

        /**
         * Vykresl√≠ seznam budov do UI.
         */
        function renderBuildings() {
            buildingsList.innerHTML = '';
            let nextUnboughtBuildingDisplayed = false;

            gameState.buildings.forEach((building, index) => {
                const isBought = building.isBought;
                const isNextAvailableInSequence = (index === 0 && !building.isBought) || (index > 0 && gameState.buildings[index - 1].isBought && !building.isBought);
                const canBuy = gameState.money >= building.price && isNextAvailableInSequence;

                // Display if bought OR if it's the next unbought building in sequence
                const shouldDisplay = isBought || (!nextUnboughtBuildingDisplayed && !isBought);
                
                if (shouldDisplay) {
                    const buildingElement = document.createElement('div');
                    buildingElement.className = 'item-card';

                    if (!isBought) {
                        // Conditionally display operation info for buildings (not for the first one)
                        const associatedOperation = OPERATIONS_DEFINITIONS[building.unlockedOperationIndex];
                        const predictedOperationYield = associatedOperation.baseClickYield;
                        const operationInfo = 
                            `<br>Nov√° Operace: "${associatedOperation.name}" (Zisk/klik: ${formatCurrency(predictedOperationYield)})`; // Changed to Nov√° Operace, always display

                        buildingElement.innerHTML = `
                            <div class="item-card-details">
                                <div class="item-card-title">
                                    <span>${building.name}</span>
                                    <span class="price">${formatCurrency(building.price)}</span>
                                </div>
                                <div class="item-card-stats">
                                    V√Ωnos zamƒõstnance: ${formatCurrency(building.employeeInitialYield)}/ks
                                    ${operationInfo}
                                    ${!isNextAvailableInSequence && index > 0 ? `<br><span class="text-red-400"> (Odemkne se po koupi ${gameState.buildings[index - 1].name})</span>` : ''}
                                </div>
                            </div>
                            <button class="btn-primary buy-building" data-index="${index}" ${!canBuy ? 'disabled' : ''}>Koupit</button>
                        `;
                    } else {
                        const unlockedOperation = gameState.operations[building.unlockedOperationIndex];
                        let currentEfficiencyBonusPercentage = 0;
                        for (const bonus of EMPLOYEE_EFFICIENCY_BONUSES) {
                            if (building.employeeCount >= bonus.count) {
                                currentEfficiencyBonusPercentage = bonus.bonus * 100;
                            }
                        }

                        const canHire = gameState.money >= building.employeeCurrentPrice && building.employeeCount < 100;
                        const individualYield = building.employeeInitialYield * (1 + (currentEfficiencyBonusPercentage / 100));

                        let nextBonusTeaser = '';
                        let nextBonusCount = -1;
                        for (const bonusTier of EMPLOYEE_EFFICIENCY_BONUSES) {
                            if (building.employeeCount < bonusTier.count) {
                                nextBonusCount = bonusTier.count;
                                break;
                            }
                        }

                        if (nextBonusCount !== -1) {
                            const remaining = nextBonusCount - building.employeeCount;
                            let employeeWord = (remaining === 1) ? 'zamƒõstnance' : 'zamƒõstnanc≈Ø';
                            nextBonusTeaser = `<br><span class="text-blue-400">Dal≈°√≠ 100% bonus za ${remaining} ${employeeWord}!</span>`;
                        }
                        // Research section is not visible for the very first operation (Obrat babku, which is OPERATIONS_DEFINITIONS[0])
                        // and also not for the 'Prodat d√°vku' (OPERATIONS_DEFINITIONS[1]) unless currentResearchLevel > 0 (it's already researched).
                        // So the check needs to be if currentResearchLevel is 0 AND it's not Obrat babku.
                        const isResearchSectionVisible = (unlockedOperation.currentResearchLevel === 0 && building.unlockedOperationIndex !== 0);

                        buildingElement.innerHTML = `
                            <div class="item-card-details w-full">
                                <div class="item-card-title mb-2">
                                    <span>${building.name} (Koupeno)</span>
                                    <span class="price">Odemƒçeno</span>
                                </div>
                                <div class="item-card-stats mb-4">
                                    Nov√° Operace: "${unlockedOperation.name}" (Zisk/klik: ${formatCurrency(unlockedOperation.baseClickYield)})
                                </div>

                                <div class="flex flex-col gap-3">
                                    <div class="compact-section">
                                        <div class="text-sm font-bold text-lime-300 mb-1">N√°bor (${building.employeeName})</div>
                                        <div class="text-zinc-200 text-xs leading-tight">
                                            ${building.employeeName} (${building.employeeCount}/100) ${getHeadIcon(building.employeeCount)}
                                            <br>V√Ωnos zamƒõstnance: ${formatCurrency(building.employeeInitialYield)}/ks
                                            <br>Celkov√Ω v√Ωnos/s: ${formatCurrency(building.employeeCount * individualYield)} <span class="text-yellow-400">(${currentEfficiencyBonusPercentage}%)</span>
                                            <br>Cena: ${formatCurrency(building.employeeCurrentPrice)}
                                            ${nextBonusTeaser}
                                        </div>
                                    </div>
                                    <button class="btn-primary hire-employee" data-building-index="${index}" ${!canHire ? 'disabled' : ''}>Najmout</button>
                                </div>

                                ${isResearchSectionVisible ? `
                                        <div class="compact-section">
                                            <div class="compact-section-details">
                                                <div class="text-sm font-bold text-lime-300 mb-1">V√Ωzkum operace: "${unlockedOperation.name}"</div>
                                                <div class="text-zinc-400 text-xs leading-tight">
                                                    Aktu√°ln√≠ √∫rove≈à: <span class="font-bold text-lime-300">${unlockedOperation.currentResearchLevel}</span>
                                                    <br>Cena dal≈°√≠ho v√Ωzkumu: <span class="font-bold text-red-400">Zdarma</span>
                                                </div>
                                            </div>
                                            <button class="btn-primary start-research-op" data-op-index="${building.unlockedOperationIndex}">
                                                Zah√°jit V√Ωzkum!
                                            </button>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    }
                    buildingsList.appendChild(buildingElement);
                    if (!isBought) { // Mark that we've displayed the first unbought building
                        nextUnboughtBuildingDisplayed = true;
                    }
                }
            });

            document.querySelectorAll('.buy-building').forEach(button => {
                button.onclick = (event) => buyBuilding(parseInt(event.target.dataset.index));
            });
            document.querySelectorAll('.hire-employee').forEach(button => {
                button.onclick = (event) => hireEmployee(parseInt(event.target.dataset.buildingIndex));
            });
            document.querySelectorAll('.start-research-op').forEach(button => {
                button.onclick = (event) => startResearchMiniGame(parseInt(event.target.dataset.opIndex));
            });
        }

        /**
         * Koup√≠ budovu.
         * @param {number} index Index budovy, kter√° se m√° koupit.
         */
        function buyBuilding(index) {
            if (gameState.gameOver) return;
            const building = gameState.buildings[index];
            const isNextAvailable = (index === 0 && !building.isBought) ||
                                   (index > 0 && gameState.buildings[index - 1].isBought && !building.isBought);

            if (gameState.money >= building.price && isNextAvailable) {
                gameState.money -= building.price;
                building.isBought = true;
                gameState.operations[building.unlockedOperationIndex].unlocked = true;
                building.strengthBonus = OPERATIONS_DEFINITIONS[building.unlockedOperationIndex].requiredStrength;

                let highestUnlockedOpIndex = 0;
                for (let i = gameState.operations.length - 1; i >= 0; i--) {
                    if (gameState.operations[i].unlocked) {
                        highestUnlockedOpIndex = i;
                        break;
                    }
                }
                gameState.activeOperationIndex = highestUnlockedOpIndex;
                
                gameState.operationLog.push({
                    type: 'building',
                    message: `Koupena budova ${building.name}.`,
                    amount: -Math.round(building.price),
                    isLoss: false
                });
                
                updateUI();
            }
        }

        /**
         * Spust√≠ mini-hru pro v√Ωzkum konkr√©tn√≠ operace.
         * @param {number} opIndex Index operace, kter√° se m√° vyzkoumat.
         */
        function startResearchMiniGame(opIndex) {
            if (gameState.gameOver) return;
            const targetOperation = gameState.operations[opIndex];

            // "Obrat babku" (index 0) is not researchable. Researchable operations have index > 0
            if (opIndex === 0 || targetOperation.currentResearchLevel > 0) {
                gameState.operationLog.push({
                    type: 'info',
                    message: `Operace "${targetOperation.name}" nepot≈ôebuje dal≈°√≠ v√Ωzkum.`,
                    amount: undefined, // No amount for info messages
                    isLoss: false
                });
                updateUI();
                return;
            }

            currentResearchOperationIndex = opIndex;
            miniGameCode = MINI_GAME_CODE;
            codeDisplay.textContent = miniGameCode;
            codeInput.value = '';
            miniGameFeedback.textContent = '';
            timerDisplay.textContent = `ƒåas: ${MINI_GAME_DURATION.toFixed(2)}s`;
            codeInput.disabled = true;
            miniGameStartButton.disabled = false;
            miniGameModal.classList.remove('hidden');
            codeInput.focus();
        }

        /**
         * Spust√≠ odpoƒçet mini-hry.
         */
        function startMiniGameCountdown() {
            miniGameTimeRemaining = MINI_GAME_DURATION;
            miniGameStartButton.disabled = true;
            codeInput.disabled = false;
            codeInput.focus();
            miniGameFeedback.textContent = '';

            miniGameTimer = setInterval(() => {
                miniGameTimeRemaining -= 0.01;
                if (miniGameTimeRemaining <= 0) {
                    clearInterval(miniGameTimer);
                    miniGameTimeRemaining = 0;
                    timerDisplay.textContent = `ƒåas: 0.00s`;
                    miniGameFeedback.textContent = 'ƒåas vypr≈°el! Zkus to znovu.';
                    miniGameFeedback.style.color = '#ff6b6b';
                    codeInput.disabled = true;
                    miniGameStartButton.disabled = false;
                } else {
                    timerDisplay.textContent = `ƒåas: ${miniGameTimeRemaining.toFixed(2)}s`;
                }
            }, 10);
        }

        /**
         * Kontroluje zad√°van√Ω k√≥d v mini-h≈ôe.
         */
        function checkMiniGameCode() {
            if (codeInput.value === miniGameCode) {
                clearInterval(miniGameTimer);
                miniGameFeedback.textContent = 'Hack √∫spƒõ≈°n√Ω!';
                miniGameFeedback.style.color = '#79d70f';
                codeInput.disabled = true;
                miniGameStartButton.disabled = true;

                const researchedOp = gameState.operations[currentResearchOperationIndex];
                researchedOp.currentResearchLevel++;
                researchedOp.currentBaseClickYield *= researchedOp.researchYieldMultiplier;
                researchedOp.currentResearchPrice *= 1.5;

                gameState.operationLog.push({
                    type: 'research',
                    message: `Technologie vyzkoum√°na: "${researchedOp.name}".`,
                    amount: 0, // Research is free, so 0 cost
                    isLoss: false
                });
                // New log entry for new operation activation
                gameState.operationLog.push({
                    type: 'activated',
                    message: `Dobra prace nov√° operace "${researchedOp.name}" aktivov√°na!`,
                    amount: undefined,
                    isLoss: false
                });

                setTimeout(() => {
                    miniGameModal.classList.add('hidden');
                    updateUI();
                }, 1000);
            } else if (codeInput.value.length >= miniGameCode.length) {
                miniGameFeedback.textContent = '≈†patn√Ω k√≥d! Zkus to znovu.';
                miniGameFeedback.style.color = '#ff6b6b';
            } else {
                miniGameFeedback.textContent = '';
            }
        }

        /**
         * Najme zamƒõstnance pro zadanou budovu.
         * @param {number} index Index budovy, pro kterou se m√° najmout zamƒõstnanec.
         */
        function hireEmployee(index) {
            if (gameState.gameOver) return;
            const building = gameState.buildings[index];
            if (gameState.money >= building.employeeCurrentPrice && building.employeeCount < 100) {
                gameState.money -= building.employeeCurrentPrice;
                building.employeeCount++;
                
                gameState.operationLog.push({
                    type: 'employee',
                    message: `Najmut ${building.employeeName} pro ${building.name} (celkem ${building.employeeCount}).`,
                    amount: -Math.round(building.employeeCurrentPrice / 1.15), // Log original price for consistency, now negative
                    isLoss: false
                });

                building.employeeCurrentPrice *= 1.15;
                updateUI();
            }
        }

        /**
         * Zkontroluje a aktualizuje stav dokonƒçen√≠ v≈°ech achievement≈Ø.
         */
        function checkAchievements() {
            gameState.achievements.forEach(achievement => {
                if (!achievement.completed && achievement.check(gameState)) {
                    achievement.completed = true;
                    gameState.operationLog.push({
                        type: 'achievement',
                        message: `Splnƒõn achievement: "${achievement.description}"!`,
                        amount: undefined, // No amount for achievement completion itself
                        isLoss: false
                    });
                }
            });
        }

        /**
         * Vykresl√≠ seznam achievement≈Ø do UI.
         */
        function renderAchievements() {
            achievementsList.innerHTML = '';
            gameState.achievements.forEach((achievement, index) => {
                const achievementElement = document.createElement('div');
                achievementElement.className = `achievement-item ${achievement.completed ? 'completed' : ''}`;
                achievementElement.innerHTML = `
                    <div class="achievement-item-header">
                        <div>
                            <span class="check-icon">${achievement.completed ? '&#10003;' : '&#9633;'}</span>
                            <span>${achievement.description}</span>
                        </div>
                        <div class="text-lime-400 font-bold">${formatCurrency(achievement.reward)}</div>
                    </div>
                    ${achievement.completed && !achievement.rewardClaimed ?
                        `<button class="btn-primary mt-2" data-index="${index}">Claim Reward</button>` : ''
                    }
                `;
                achievementsList.appendChild(achievementElement);
            });

            document.querySelectorAll('#achievements-list .btn-primary').forEach(button => {
                button.onclick = (event) => claimAchievementReward(parseInt(event.target.dataset.index));
            });
        }

        /**
         * Udƒõl√≠ odmƒõnu za achievement.
         * @param {number} index Index achievementu, za kter√Ω se m√° vybrat odmƒõna.
         */
        function claimAchievementReward(index) {
            if (gameState.gameOver) return;
            const achievement = gameState.achievements[index];
            if (achievement.completed && !achievement.rewardClaimed) {
                gameState.money += achievement.reward;
                achievement.rewardClaimed = true;
                
                gameState.operationLog.push({
                    type: 'reward',
                    message: `Z√≠skan√° odmƒõna za achievement "${achievement.description}".`,
                    amount: achievement.reward,
                    isLoss: false
                });

                updateUI();
            }
        }

        /**
         * Vykresl√≠ log operac√≠ do UI.
         */
        function renderOperationLog() {
            operationLogElement.innerHTML = '';
            // Display only up to the last 10 entries
            const entriesToDisplay = gameState.operationLog.slice(-10).reverse();

            entriesToDisplay.forEach(entry => {
                const div = document.createElement('div');
                // Apply 'loss' class if it's a financial loss (amount < 0) or an action outcome loss (isLoss true)
                div.className = `log-entry ${entry.isLoss || (entry.amount !== undefined && entry.amount < 0) ? 'loss' : ''} ${entry.type === 'activated' ? 'research-activated' : ''}`;

                // Determine the prefix text based on entry type
                let prefixText = '';
                switch (entry.type) {
                    case 'action':
                        prefixText = 'Akce:';
                        break;
                    case 'gang':
                        prefixText = 'Gang:';
                        break;
                    case 'building':
                        prefixText = 'Budova:';
                        break;
                    case 'research':
                        prefixText = 'V√Ωzkum:';
                        break;
                    case 'employee':
                        prefixText = 'Zamƒõstnanec:';
                        break;
                    case 'achievement':
                        prefixText = 'Achievement:';
                        break;
                    case 'reward':
                        prefixText = 'Odmƒõna:';
                        break;
                    case 'info':
                        prefixText = 'Info:';
                        break;
                    case 'activated':
                        prefixText = 'Aktivace:'; // New prefix for activated operations
                        break;
                }

                // Determine the amount text based on positive or negative amount
                let amountDisplay = '';
                if (entry.amount !== undefined) {
                    if (entry.amount < 0) {
                        amountDisplay = `Odebr√°no: ${formatCurrency(entry.amount)}`;
                    } else {
                        amountDisplay = `Z√≠sk√°no: ${formatCurrency(entry.amount)}`;
                    }
                }

                div.innerHTML = `
                    <span class="log-prefix">> ${prefixText}</span>
                    <span class="log-message">${entry.message}</span>
                    <span class="log-amount">${amountDisplay}</span>
                `;
                operationLogElement.appendChild(div);
            });
        }

        /**
         * Inicializuje hern√≠ stav a nastav√≠ hern√≠ smyƒçku.
         */
        function initGameCore() { // Renamed to avoid confusion with the start button handler
            // Inicializace UI
            updateUI();

            // Nastaven√≠ hlavn√≠ hern√≠ smyƒçky pro pasivn√≠ p≈ô√≠jem
            setInterval(() => {
                if (gameState.gameOver) return;

                // P≈ôid√° pasivn√≠ p≈ô√≠jem
                gameState.money += calculatePassiveIncome();

                updateUI(); // Vol√°me updateUI v ka≈æd√©m cyklu intervalu
            }, 1000); // Smyƒçka se spou≈°t√≠ ka≈ædou sekundu
        }

        // --- Posluchaƒçe ud√°lost√≠ ---
        clickButton.addEventListener('click', handleClick);

        // Posluchaƒçe pro z√°lo≈ækov√° tlaƒç√≠tka
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // Only allow click if the tab is not disabled
                if (button.disabled) {
                    return; // Do nothing if disabled
                }

                tabButtons.forEach(btn => btn.classList.remove('active-tab'));
                tabPanels.forEach(panel => panel.classList.add('hidden'));

                button.classList.add('active-tab');
                document.getElementById(button.dataset.tab).classList.remove('hidden');

                // Znovu vykresl√≠ relevantn√≠ seznamy p≈ôi p≈ôep√≠n√°n√≠ z√°lo≈æek, aby byly aktu√°ln√≠
                if (button.dataset.tab === 'ai-bots') {
                    renderAIBots();
                } else if (button.dataset.tab === 'buildings') {
                    renderBuildings(); // Nyn√≠ renderuje budovy
                }
                else if (button.dataset.tab === 'achievements') {
                    renderAchievements();
                }
            });
        });

        // Mini-game event listeners
        miniGameStartButton.addEventListener('click', startMiniGameCountdown);
        codeInput.addEventListener('input', checkMiniGameCode);
        miniGameCancelButton.addEventListener('click', () => { // Added missing event listener for cancel button
            clearInterval(miniGameTimer);
            miniGameModal.classList.add('hidden');
            updateUI();
        });

        // Event listener for the "Start Game" button on the welcome modal
        startGameButton.addEventListener('click', () => {
            welcomeModal.classList.add('hidden'); // Hide modal
            gameContainer.classList.remove('hidden'); // Show game
            initGameCore(); // Start the game's core logic
        });
    </script>
</body>
</html>
